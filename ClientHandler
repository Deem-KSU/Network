import java.io.*;
import java.net.*;
import java.util.*;
// Shared TrainManager instance for all clients
public class ClientHandler implements Runnable {

    private Socket client;// Represents this clients socket                   
    private BufferedReader in;// To read messages from the client              
    private PrintWriter out;// To send messages to the client                
    private TrainManager manager;// Shared TrainManager for all clients          

    // Constructor that initializes the handler with the client's socket and shared TrainManager
    public ClientHandler(Socket client, TrainManager manager) throws IOException {
        this.client = client;
        this.manager = manager;
        this.in = new BufferedReader(new InputStreamReader(client.getInputStream()));
        this.out = new PrintWriter(client.getOutputStream(), true);
    }
//The main logic that runs in a separate thread for each client

    @Override
    public void run() {
        try {
            out.println("Welcome to Train Reservation System!");
            out.println("Commands: FIND <source> <destination> <day> <classType> | RESERVE <ticketId> | SHOWALL | EXIT");

            String line;
            while ((line = in.readLine()) != null) {
                line = line.trim();
                if (line.equalsIgnoreCase("exit")) {
                    out.println("Goodbye!");
                    break;
                }

                String[] parts = line.split("\\s+");
                String command = parts[0].toUpperCase();
               // Execute the proper command based on input
                switch (command) {
                    case "FIND":// list available tickets

                        if (parts.length != 5) {
                            out.println("Usage: FIND <source> <destination> <day> <classType>");
                        } else {
                            String source = parts[1];
                            String destination = parts[2];
                            int day = Integer.parseInt(parts[3]);
                            String classType = parts[4];
                            ArrayList<Ticket> found = manager.findAvailableTickets(source, destination, day, classType);
                            if (found.isEmpty()) {
                                out.println("No available tickets found.");
                            } else {
                                out.println("Available tickets:");
                                for (Ticket t : found) {
                                    out.println(t.toString());
                                }
                                out.println("");
                            }
                        }
                        break;

                    case "RESERVE":// reserve a ticket by id
                        if (parts.length != 2) {
                            out.println("Usage: RESERVE <ticketId>");
                        } else {
                            String ticketId = parts[1];
                            boolean success = manager.reserveTicket(ticketId);
                            if (success) {
                                out.println("Ticket " + ticketId + " reserved successfully!");
                            } else {
                                out.println("Failed to reserve ticket (already reserved or not found).");
                            }
                        }
                        break;

                       default:
                        out.println("Unknown command. Try FIND, RESERVE, SHOWALL, or EXIT.");
                        break;
                }
            }

        } catch (IOException e) {
            System.out.println("Client disconnected: " + client.getInetAddress());
        } finally {
         // close connection

            try {
                client.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
}

